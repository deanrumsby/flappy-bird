pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- flappy bird
-- by dean rumsby


waiting=true


-- factory functions --
-----------------------

function make_pipe(x,y)
 local pipe={
  x=x,
  y=y,
  w=24,
  h=96,
  dx=1,
  
  update=function(self)
   self.x-=self.dx
  end,
  
  draw=function(self)
   -- top section
   for i=0,2 do
    spr(i,self.x+i*8,self.y)
   end
   -- middle section
   for i=1,10 do
    for j=0,2 do
     spr(16+j,self.x+j*8,self.y+i*8)
    end
   end
   -- bottom section
   for i=0,2 do
    spr(i,self.x+i*8,self.y+88)
   end 
  end
 }
 return pipe
end


-- score --
-----------

score={
 v=0,      -- score
 x=62,     -- x pos
 y=10,     -- y pos
 sprs={},  -- sprite font map
 
 init=function(self)
  self.sprs["0"] = {32,48}
 end,
 
 draw=function(self)
  local str=tostr(self.v)
  for i=1,#str do
   local d=sub(str,i)
   spr(self.sprs[d][1],self.x,self.y)
   spr(self.sprs[d][2],self.x,self.y+8)
  end
 end
}


-- bird --
----------

bird={
 x=30,        -- x pos
 y=60,        -- y pos
 w=16,        -- width
 h=12,        -- height
 dy=0,        -- velocity
 wing_u=0,    -- wing u pos
 wing_v=3,    -- wing v pos
 flap=0,      -- animation counter
 a=0.5,       -- acceleration
 
 update=function(self)
  -- press üÖæÔ∏è to flap
  if btnp(üÖæÔ∏è) then
   self.dy=-4.5
   waiting=false
  end
  
  -- if waiting go no further
  if (waiting) return
  
  -- apply motion
  self.dy+=self.a
  self.y+=self.dy
  
  -- increment counter
  -- used for animation
  if self.flap<6 then
   self.flap+=1
  else
   self.flap=0
  end
 end,
 
 draw=function(self)
  -- body
  spr(4,self.x,self.y)
  spr(5,self.x+8,self.y)
  spr(20,self.x,self.y+8)
  spr(21,self.x+8,self.y+8)
  
  -- wing animation
  local wing=7
  if (self.flap>=2) wing=6
  if (self.flap>=4) wing=22
  spr(wing,self.x+self.wing_u,self.y+self.wing_v)
 end
}


-- pipes --
-----------

pipes={
 list={}, -- array of pipes
 
 init=function(self)
  -- create initial gates
  for i=1,4 do
   add(self.list, self:add_gate(80+i*70))
  end
 end,
 
 add_gate=function(self, x)
  local y=rnd(54)+10 
  add(self.list,make_pipe(x,y-96))
  add(self.list,make_pipe(x,y+40))
 end,
 
 remove_gate=function(self)
  deli(self.list,1)
  deli(self.list,1)
 end, 
 
 update=function(self)
  -- update positions
  for p in all(self.list) do
   p:update()
  end
  
  -- only track visible 
  -- pipes
  local first=self.list[1]
  local last=self.list[#self.list]
  if first.x<-first.w then
   self:remove_gate()
   self:add_gate(last.x+70)
  end
 end,
  
 draw=function(self)
  for p in all(self.list) do
   p:draw()
  end
 end
}

-- ground --
------------

ground={
 y=114,  -- y pos
 c=-1,   -- animation counter
 
 update=function(self)
  -- update animation counter
  if self.c<7 then
   self.c+=1
  else
   self.c=0
  end
 end,
 
 draw=function(self)
  for i=0,19 do
    spr(9,i*8-self.c,self.y)
  end
 end 
} 


-- game loop --
---------------

function _init()
 -- wait for first input
 waiting=true
 
 -- change transparent color
 palt(0,false)
 palt(2,true)
 
 -- create starting pipes 
 pipes:init()
 
 score:init()
end

function _update()
 bird:update()
 
 -- if waiting do not update
 -- further
 if (waiting) return
 
 pipes:update()
 ground:update()
 
 -- handle collisions
 resolve_collisions()
end

function _draw()
 -- clear screen
 cls()
 
 -- draw background image
 map()
 
 -- draw entities
 pipes:draw()
 ground:draw()
 bird:draw()
 score:draw()
 
 -- draws the ground map tiles
 -- over the pipes using
 -- sprite flag 0x01
 map(0,0,0,0,16,16,1)
end


-- collision system --
----------------------

-- using axis aligned
-- bounding box collision
function collision(a,b)
 return (
  a.x<b.x+b.w
  and a.x+a.w>b.x
  and a.y<b.y+b.h
  and a.y+a.h>b.y
 )
end

function resolve_collisions()
 -- bird and pipe
 local col=false
 for p in all(pipes.list) do
  if collision(bird,p) then
   bird.c=8
   return
  end
 end
 bird.c=10
end
__gfx__
00000000000000000000000000000000222222000000222220000222222222220000000000000000000000000000000000000000000000000000000000000000
0bb7777777777bbbbbbbbb3000000000222200fff077022207777022222222220000000077777777000000000000000000000000000000000000000000000000
0b7bbbbbbbbbbbbbbbb3b330000000002220ffaa07777022077777022000002200000000bb3333bb000000000000000000000000000000000000000000000000
0b7bbbbbbbbbbbbbbbb3b33000000000220faaaa06770702067776020777770200000000b3333bbb000000000000000000000000000000000000000000000000
0b7bbbbbbbbbbbbbbbb3b3300000000020aaaaaa067707022066602206777602000000003333bbbb000000000000000000000000000000000000000000000000
0b7bbbbbbbbbbbbbbbb3b3300000000020aaaaaaa067770222000222200000220000000044444444000000000000000000000000000000000000000000000000
0b7bbbbbbbbbbbbbbbb3b330000000000aaaaaaaaa000000222222222222222200000000ffffffff000000000000000000000000000000000000000000000000
0000000000000000000000000000000009999999a0888880222222222222222200000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002099999908000000222222220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002209999990888802222222220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002220099999000002222222220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002222200000222222200000220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002222222222222222067776020000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002222222222222222077770220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002222222222222222077602220000000000000000ffffffff000000000000000000000000000000000000000000000000
220b7bbbbbbbbbbbb3b33022000000002222222222222222200002220000000000000000ffffffff000000000000000000000000000000000000000000000000
00000002222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07707702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
07777702222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000002222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
22222222222222222222222222222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
cccccc777777cccccccccccccccccccccccccccccccccccccccccccccccccccc77777777777777777777777777777777000000000000000000000000bbbbbbbb
cccc7777777777cccccccccccccccccccccccccccccccc777777cccccccccccc77777777777777777777777777777777000000000000000000000000bbbbbbbb
cc77777777777777cccccccccccccccccccccccccccc7777777777cccccccccc77777777777777777777777777777777000000000000000000000000bbbbbbbb
c7777777777777777ccccccccccccccccccccccccc77777777777777cccccccc77777777777777777777777777777777000000000000000000000000bbbbbbbb
777777777777777777ccccccccccccccccccccccc7777777777777777cccc7777777777777777777777666ccccc77777000000000000000000000000bbbbbbbb
7777777777777777777ccccccccccccccccccccc777777777777777777cc77777777777777777777777677c777c77777000000000000000000000000bbbbbbbb
7777777777777777777ccccccccc777777ccccc7777777777777777777777777777777766666777777ccccc767c77777000000000000000000000000bbbbbbbb
77777777777777777777cccccc7777777777ccc7777777777777777777777777777776666666777777c7777777c77777000000000000000000000000bbbbbbbb
00000000000000000000000000000000000000000000000000000000000000007777666666ccccccc7c7676767cccc7700000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000007776666666c77776c7c7676767c67c7700000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000007776666666c76776c7c7777777cccccc00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666cccccccccc7c7676767c6777c00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666c77777766c7c7676767c6777c00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666c67676766c7c7777777c6767c00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666c67676766c6c7777777c6767c00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666c77777cccccc7676767c6777c00000000000000000000000077777777
00000000000000000000000000000000000000000000000000000000000000006676666c67676c7776c7676767c6767c000000000000000000000000cccccccc
00000000000000000000000000000000000000000000000000000000000000006666666c67676c7676c7777777c6767c000000000000000000000000cccccccc
00000000000000000000000000000000000000000000000000000000000000006666666c77777c7676c7676767c6777c000000000000000000000000cccccccc
00000000000000000000000000000000000000000000000000000000000000006333366cc7c7cc773333c7c7c733337c000000000000000000000000cccccccc
00000000000000000000000000000000000000000000000000000000000000003bbbb33cc7c7cc33bbbb337733bbbb33000000000000000000000000cccccccc
0000000000000000000000000000000000000000000000000000000000000000bbbbbbb33773333bbbbbbb33bbbbbbbb000000000000000000000000cccccccc
0000000000000000000000000000000000000000000000000000000000000000bbbbbbb3333bbbb33bbbbbbb3bbbbbbb000000000000000000000000cccccccc
0000000000000000000000000000000000000000000000000000000000000000bbbbbbb33bbbbbbbb33bbbbb3bbbbbbb000000000000000000000000cccccccc
0000000000000000000000000000000000000000000000000000000000000000b3333b3bbbbbbbbbbbb3bbb3333bbbbb000000000000000000000000ffffffff
00000000000000000000000000000000000000000000000000000000000000003bbbb33bbbbbbbbbbbb3b33bbbb33bb3000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbb33bbbbbbbbbb33bbbbbbbb33b000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbb3bbbbbbbb3bbbbbbbbbbb3b000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000ffffffff
0000000000000000000000000000000000000000000000000000000000000000bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000ffffffff
__gff__
0000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f6f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4041424344454647404142434445464700000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
48494a4b48494a4b48494a4b48494a4b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
58595a5b58595a5b58595a5b58595a5b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
68696a6b68696a6b68696a6b68696a6b00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
78797a7b78797a7b78797a7b78797a7b0c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f4f5b000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f7f00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000600001f3001f3001f3001f3003335033350333303333033310333103f200000000000027000320503205033030340303401033010330003f50000000000003f60000000000003f70000000000000000000000
